unit uMercurySMTPEventHandler;

interface
uses MPEvent, MSEvent, daemon;

function startup(m: PM_INTERFACE; var flags: UINT_32; name: PAnsiChar;
  param: PAnsiChar): Smallint; cdecl; export;

{$IF DEFINED(CLOSEDOWN)}
function closedown(m: PM_INTERFACE; code: UINT_32; name: PAnsiChar;
  param: PAnsiChar): Smallint; cdecl; export;
{$ENDIF}

implementation
uses System.SysUtils;

var
  mi: M_INTERFACE;
  ModuleName: AnsiString;

function SMTPEventHandler(module: UINT_32; event: UINT_32;
  edata: Pointer; cdata: Pointer): INT_32; cdecl;
var
  pms: PMSEventBuf;
  IPAddress, Text, LDateTime: AnsiString;
begin
  pms := PMSEventBuf(edata);
  IPAddress := AnsiString(pms.client);

  LDateTime := AnsiString(FormatDateTime('d mmm h:nn:ss am/pm', Now));
  Text := AnsiString(Format('%s - POP3 Event Handler called.', [LDateTime]));

  mi.logdata(19400, LOG_NORMAL, '%s: connection from %s',
    PAnsiChar(AnsiString(ModuleName)), PAnsiChar(IPAddress));

  Result := 1; // Non-zero to indicate success!
end;

function startup(m: PM_INTERFACE; var flags: UINT_32; name: PAnsiChar;
  param: PAnsiChar): Smallint;
var
  Text: AnsiString;
begin
  ModuleName := AnsiString(name);
  if m.register_event_handler(MMI_MERCURYS, MSEVT_CONNECT, @SMTPEventHandler, nil)=0 then
    Text := 'Failed to register event handler' else
    Text := 'Successfully registered StopSMTPAttack';
  LastConnectionTime := TDictionary<AnsiString, TDateTime>.Create;
  m.logstring(19400, LOG_SIGNIFICANT, PAnsiChar(Text));
  mi := m^;
  Result := 1; // Non-zero to indicate success!
end;

{$IF DEFINED(CLOSEDOWN)}
function closedown(m: PM_INTERFACE; code: UINT_32; name: PAnsiChar;
  param: PAnsiChar): Smallint;
begin

end;
{$ENDIF}

end.

